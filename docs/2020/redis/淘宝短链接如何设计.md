
##æ·˜å®çŸ­é“¾æ¥å¦‚ä½•è®¾è®¡ï¼Ÿ

### ä½“éªŒæ·˜å®çŸ­é“¾æ¥ä¸šåŠ¡åœºæ™¯
#### åœºæ™¯1ï¼šæ·˜å®çŸ­ä¿¡
ä½ ä»¬åº”è¯¥æ”¶åˆ°æ·˜å®çš„çŸ­ä¿¡
```
ã€å¤©çŒ«ã€‘æœ‰ä¼˜æƒ å•¦ï¼é»„çš®é‡‘ç…ŒèŠ’æœï¼ˆæ°´ä»™èŠ’ï¼‰å¸¦ç®±10æ–¤49.8å…ƒï¼
æ ¸è–„æ— ä¸å¾ˆç”œå–”ï¼è´­ä¹°ï¼š c.tb.cn/c.ZzhFZ0 æ€¥é²œä¸° é€€è®¢å›TD
```
æ‰“å¼€IEï¼Œè¾“å…¥ c.tb.cn/c.ZzhFZ0 å°±è½¬å˜ä¸ºå¦‚ä¸‹:
https://h5.m.taobao.com/ecrm/jump-to-app.html?scm=20140608.2928562577.LT_ITEM.1699166744&target_url=
http%3A%2F%2Fh5.m.taobao.com%2Fawp%2Fcore%2Fdetail.htm%3Fid%3D567221004504%26scm=20140607.2928562577.
LT_ITEM.1699166744&spm=a313p.5.1cfl9ch.947174560063&short_name=c.ZzhFZ0&app=chrome



#### åœºæ™¯2ï¼šæ·˜å®APPåˆ†äº«URL


```
ã€è¿™ä¸ª#èšåˆ’ç®—å›¢è´­#å®è´ä¸é”™:ã€å®˜æ–¹æ——èˆ°ã€‘æ­¥æ­¥é«˜å®¶æ•™æœºS5è‹±è¯­å°å­¦åˆé«˜ä¸­è¯¾æœ¬åŒæ­¥å°å¤©æ‰å¹³æ¿
å„¿ç«¥ç‚¹è¯»å­¦ä¹ æœºæ™ºèƒ½å­¦ç”Ÿå¹³æ¿ç”µè„‘æŠ¤çœ¼æ——èˆ°åº—(åˆ†äº«è‡ª@æ‰‹æœºæ·˜å®androidå®¢æˆ·ç«¯)ã€‘
https://m.tb.cn/h.eAE6vuE 
é»ï¿¡æ“Šâ˜†éˆã„£æ¥ï¼Œå†é€‰æ‹©ç€è¦½â†’å™å’‘ãºé¦ï¼›æˆ–æ¤±ã‚¡è£½è¿™å¥è¯â‚¬eyuf1YeAXFfâ‚¬åæ‰“å¼€ğŸ‘‰æ·˜å®€â”¡Ä“ğŸ‘ˆ
```
æ‰“å¼€IEï¼Œè¾“å…¥https://m.tb.cn/h.eAE6vuE  å°±è½¬å˜ä¸ºå¦‚ä¸‹:
https://detail.tmall.com/item.htm?id=597254411409&price=3998-4398&sourceType=item&sourceType=item&suid=
4c8fc4d8-cb5e-40c0-b4b6-c4a06598781a&ut_sk=1.WmH11veugHoDAGWzSv+jAZg2_21646297_1574219840558.Copy.1&un
=ceed7d76bfbe7a3b4b68d5f77a161062&share_crt_v=1&spm=a2159r.13376460.0.0&sp_tk=4oKzaUU0SllFcWZuRjLigrM=
&cpp=1&shareurl=true&short_name=h.eF25Q3n&sm=505e90&app=chrome&sku_properties=1627207:28332

ä½“éªŒäº†ä»¥ä¸Š2ä¸ªåœºæ™¯ï¼Œæˆ‘ä»¬æ¥æ€»ç»“ï¼š
1. å…ˆè¯´ä¸‹ä»€ä¹ˆæ˜¯çŸ­é“¾æ¥ï¼Ÿ
å°±æ˜¯æŠŠæ™®é€šç½‘å€ï¼Œè½¬æ¢æˆæ¯”è¾ƒçŸ­çš„ç½‘å€ã€‚  
2. çŸ­é“¾æ¥æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ
- èŠ‚çœç½‘å€é•¿åº¦ï¼Œä¾¿äºç¤¾äº¤åŒ–ä¼ æ’­ã€‚
- æ–¹ä¾¿åå°è·Ÿè¸ªç‚¹å‡»é‡ã€ç»Ÿè®¡ã€‚



### æ¡ˆä¾‹å®æˆ˜ï¼šSpringBoot+Redisé«˜å¹¶å‘ã€ŠçŸ­é“¾æ¥è½¬æ¢å™¨ã€‹
ã€ŠçŸ­é“¾æ¥è½¬æ¢å™¨ã€‹çš„åŸç†ï¼š
1. é•¿é“¾æ¥è½¬æ¢ä¸ºçŸ­é“¾æ¥
å®ç°åŸç†ï¼šé•¿é“¾æ¥è½¬æ¢ä¸ºçŸ­é“¾æ¥åŠ å¯†ä¸²key,ç„¶åå­˜å‚¨äºredisçš„hashç»“æ„ä¸­ã€‚
2. é‡å®šå‘åˆ°åŸå§‹çš„url
å®ç°åŸç†ï¼šé€šè¿‡åŠ å¯†ä¸²keyåˆ°redisæ‰¾å‡ºåŸå§‹urlï¼Œç„¶åé‡å®šå‘å‡ºå»

#### Controller
```java
@RestController
@Slf4j
public class ShortUrlController {

    @Autowired
    private HttpServletResponse response;

    @Autowired
    private RedisTemplate redisTemplate;
    private  final static  String SHORT_URL_KEY="short:url";

    /**
     * é•¿é“¾æ¥è½¬æ¢ä¸ºçŸ­é“¾æ¥
     * å®ç°åŸç†ï¼šé•¿é“¾æ¥è½¬æ¢ä¸ºçŸ­åŠ å¯†ä¸²keyï¼Œç„¶åå­˜å‚¨åœ¨redisçš„hashç»“æ„ä¸­ã€‚
     */
    @GetMapping(value = "/encode")
    public String encode(String url) {
        //ä¸€ä¸ªé•¿é“¾æ¥urlè½¬æ¢ä¸º4ä¸ªçŸ­åŠ å¯†ä¸²key
        String [] keys= ShortUrlGenerator.shortUrl(url);
        //ä»»æ„å–å‡ºå…¶ä¸­ä¸€ä¸ªï¼Œæˆ‘ä»¬å°±æ‹¿ç¬¬ä¸€ä¸ª
        String key=keys[0];
        //ç”¨hashå­˜å‚¨ï¼Œkey=åŠ å¯†ä¸²ï¼Œvalue=åŸå§‹url
        this.redisTemplate.opsForHash().put(SHORT_URL_KEY,key,url);
        log.info("é•¿é“¾æ¥={}ï¼Œè½¬æ¢={}",url,key);
        return "http://127.0.0.1:9090/"+key;
    }

    /**
     * é‡å®šå‘åˆ°åŸå§‹çš„URL
     * å®ç°åŸç†ï¼šé€šè¿‡çŸ­åŠ å¯†ä¸²KEYåˆ°redisæ‰¾å‡ºåŸå§‹URLï¼Œç„¶åé‡å®šå‘å‡ºå»
     */
    @GetMapping(value = "/{key}")
    public void decode(@PathVariable String key) {
        //åˆ°redisä¸­æŠŠåŸå§‹urlæ‰¾å‡ºæ¥
        String url=(String) this.redisTemplate.opsForHash().get(SHORT_URL_KEY,key);
        try {
            //é‡å®šå‘åˆ°åŸå§‹çš„url
            response.sendRedirect(url);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

#### Util

```java
package com.agan.redis.service;


import org.apache.commons.codec.digest.DigestUtils;

/**
 * å°†é•¿ç½‘å€ md5 ç”Ÿæˆ 32 ä½ç­¾åä¸²,åˆ†ä¸º 4 æ®µ, æ¯æ®µ 8 ä¸ªå­—èŠ‚
 * å¯¹è¿™å››æ®µå¾ªç¯å¤„ç†, å– 8 ä¸ªå­—èŠ‚, å°†ä»–çœ‹æˆ 16 è¿›åˆ¶ä¸²ä¸ 0x3fffffff(30ä½1) ä¸æ“ä½œ, å³è¶…è¿‡ 30 ä½çš„å¿½ç•¥å¤„ç†
 * è¿™ 30 ä½åˆ†æˆ 6 æ®µ, æ¯ 5 ä½çš„æ•°å­—ä½œä¸ºå­—æ¯è¡¨çš„ç´¢å¼•å–å¾—ç‰¹å®šå­—ç¬¦, ä¾æ¬¡è¿›è¡Œè·å¾— 6 ä½å­—ç¬¦ä¸²
 * æ€»çš„ md5 ä¸²å¯ä»¥è·å¾— 4 ä¸ª 6 ä½ä¸²,å–é‡Œé¢çš„ä»»æ„ä¸€ä¸ªå°±å¯ä½œä¸ºè¿™ä¸ªé•¿ url çš„çŸ­ url åœ°å€
 */
public class ShortUrlGenerator {
    //26+26+10=62
    public static  final  String[] chars = new String[]{"a", "b", "c", "d", "e", "f", "g", "h",
            "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t",
            "u", "v", "w", "x", "y", "z", "0", "1", "2", "3", "4", "5",
            "6", "7", "8", "9", "A", "B", "C", "D", "E", "F", "G", "H",
            "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T",
            "U", "V", "W", "X", "Y", "Z"};



    /**
     * ä¸€ä¸ªé•¿é“¾æ¥URLè½¬æ¢ä¸º4ä¸ªçŸ­KEY
     */
    public static String[] shortUrl(String url) {
        String key = "";
        //å¯¹åœ°å€è¿›è¡Œmd5
        String sMD5EncryptResult = DigestUtils.md5Hex(key + url);
        System.out.println(sMD5EncryptResult);
        String hex = sMD5EncryptResult;
        String[] resUrl = new String[4];
        for (int i = 0; i < 4; i++) {
            //å–å‡º8ä½å­—ç¬¦ä¸²ï¼Œmd5 32ä½ï¼Œè¢«åˆ‡å‰²ä¸º4ç»„ï¼Œæ¯ç»„8ä¸ªå­—ç¬¦
            String sTempSubString = hex.substring(i * 8, i * 8 + 8);

            //å…ˆè½¬æ¢ä¸º16è¿›è´¦ï¼Œç„¶åç”¨0x3FFFFFFFè¿›è¡Œä½ä¸è¿ç®—ï¼Œç›®çš„æ˜¯æ ¼å¼åŒ–æˆªå–å‰30ä½
            long lHexLong = 0x3FFFFFFF & Long.parseLong(sTempSubString, 16);

            String outChars = "";
            for (int j = 0; j < 6; j++) {
                //0x0000003Dä»£è¡¨ä»€ä¹ˆæ„æ€ï¼Ÿä»–çš„10è¿›åˆ¶æ˜¯61ï¼Œ61ä»£è¡¨charsæ•°ç»„é•¿åº¦62çš„0åˆ°61çš„åæ ‡ã€‚
                //0x0000003D & lHexLongè¿›è¡Œä½ä¸è¿ç®—ï¼Œå°±æ˜¯æ ¼å¼åŒ–ä¸º6ä½ï¼Œå³61å†…çš„æ•°å­—
                //ä¿è¯äº†indexç»å¯¹æ˜¯61ä»¥å†…çš„å€¼
                long index = 0x0000003D & lHexLong;

                outChars += chars[(int) index];
                //æ¯æ¬¡å¾ªç¯æŒ‰ä½ç§»5ä½ï¼Œå› ä¸º30ä½çš„äºŒè¿›åˆ¶ï¼Œåˆ†6æ¬¡å¾ªç¯ï¼Œå³æ¯æ¬¡å³ç§»5ä½
                lHexLong = lHexLong >> 5;
            }

            // æŠŠå­—ç¬¦ä¸²å­˜å…¥å¯¹åº”ç´¢å¼•çš„è¾“å‡ºæ•°ç»„
            resUrl[i] = outChars;
        }
        return resUrl;
    }

    public static void main(String[] args) {
        // é•¿è¿æ¥
        String longUrl = "https://detail.tmall.com/item.htm?id=597254411409";
        // è½¬æ¢æˆçš„çŸ­é“¾æ¥å6ä½ç ï¼Œè¿”å›4ä¸ªçŸ­é“¾æ¥
        String[] shortCodeArray = shortUrl(longUrl);

        for (int i = 0; i < shortCodeArray.length; i++) {
            // ä»»æ„ä¸€ä¸ªéƒ½å¯ä»¥ä½œä¸ºçŸ­é“¾æ¥ç 
            System.out.println(shortCodeArray[i]);
        }
    }
}

```
